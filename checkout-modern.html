<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Public Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    emailjs.init("EUHurGnUrY9Q-SbaO"); 
</script>

<script>
// ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ + QR
document.addEventListener("DOMContentLoaded", function () {
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");
    let totalPrice = localStorage.getItem("totalPrice") || 0;

    // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    document.getElementById("order-items").innerHTML =
        cart.map(item =>
            `<li>üì¶ ${item.name} x${item.quantity} ‚Äî ${item.price * item.quantity} ‡∏ö‡∏≤‡∏ó</li>`
        ).join("");

    // ‡∏£‡∏≤‡∏Ñ‡∏≤
    document.getElementById("display-price").innerText = totalPrice;

    // QR
    let promptpayNumber = "0639392988";
    document.getElementById("qr-code").src =
        `https://promptpay.io/${promptpayNumber}/${totalPrice}.png`;
});

// Preview slip
function previewSlip() {
    const file = document.getElementById('slipUpload').files[0];
    if (!file) return;

    document.getElementById('slipPreview').src = URL.createObjectURL(file);
    document.getElementById('slipPreviewContainer').classList.remove('hidden');
}

// ------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡πà‡∏≤‡∏ô EmailJS
// ------------------------------
function sendOrderToEmail(name, email, address, phone, orderDetails, totalPrice, slipFile) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function (e) {

            emailjs.send("your_service_id", "your_template_id", {
                customer_name: name,
                customer_email: email,
                customer_address: address,
                customer_phone: phone,
                order_list: orderDetails,
                order_total: totalPrice,
                slip_image: e.target.result
            })
            .then(resolve)
            .catch(reject);
        };

        reader.readAsDataURL(slipFile);
    });
}

// ------------------------------
// ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
// ------------------------------
document.getElementById("confirmOrderBtn").addEventListener("click", function () {
    let name = document.getElementById("customer-name").value.trim();
    let email = document.getElementById("customer-email").value.trim();
    let address = document.getElementById("customer-address").value.trim();
    let phone = document.getElementById("customer-phone").value.trim();
    let slipFile = document.getElementById("slipUpload").files[0];

    if (!name || !email || !address || !phone || !slipFile) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢");
        return;
    }

    let cart = JSON.parse(localStorage.getItem("cart") || "[]");
    let totalPrice = localStorage.getItem("totalPrice") || 0;

    let orderDetails = cart.map(item =>
        `${item.name} x${item.quantity} = ${item.price * item.quantity} ‡∏ö‡∏≤‡∏ó`
    ).join("\n");

    let btn = document.getElementById("confirmOrderBtn");
    btn.disabled = true;
    btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...";

    sendOrderToEmail(name, email, address, phone, orderDetails, totalPrice, slipFile)
        .then(() => {
            alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");

            localStorage.removeItem("cart");
            localStorage.removeItem("totalPrice");

            setTimeout(() => {
                window.location.href = "index-modern.html";
            }, 1500);
        })
        .catch(err => {
            console.error(err);
            alert("‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Service ID ‡πÅ‡∏•‡∏∞ Template ID");
            btn.disabled = false;
            btn.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
        });
});
</script>